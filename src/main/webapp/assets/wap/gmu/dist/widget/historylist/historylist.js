(function(e,t){e.define("Historylist",{options:{container:document.body,deleteSupport:!0,items:[]},template:{wrap:'<ul class="ui-historylist">',item:'<li data-id="<%=id%>"><p class="ui-historylist-itemwrap"><span class="ui-historylist-item"><%=context%></span></p></li>',clear:'<p class="ui-historylist-clear">清空搜索历史</p>'},_init:function(){var e=this,t=e._options;e.$el=t.container=t.container||document.body,e.items=[],e.on("ready",function(){e._bindUI()}),e.on("itemDelete",function(){e.items.length===0&&e.hide()})},_create:function(){var e=this,n=e._options;e.$el.hide(),e.$wrap=t(e.tpl2html("wrap")).appendTo(n.container),e.$clear=t(e.tpl2html("clear")).appendTo(n.container),!e._options.deleteSupport&&e.$clear.hide(),e.addItems(n.items),e.show()},_filterItemsById:function(e,t){var n=this;n.items.forEach(function(r,i){if(r.id===e){t.call(n,r,i);return}})},_bindUI:function(){var n=this,r,i,s,o,u,a=!1,f,l,c,h,p,d,v,m,g;n.$clear.on("tap"+n.eventNs,function(t){setTimeout(function(){e.Dialog({closeBtn:!1,buttons:{"清空":function(){n.clear(),this.destroy()},"取消":function(){this.destroy()}},title:"清空历史",content:"<p>是否清空搜索历史？</p>",open:function(){this._options._wrap.addClass("ui-historylist-dialog")}})},10),t.preventDefault(),t.stopPropagation()}),n.$wrap.on("tap"+n.eventNs,function(e){if(n._options.deleteSupport)return;i=t(e.target);if(!i.hasClass("ui-historylist-itemwrap")&&!(i=i.parents(".ui-historylist-itemwrap")).length){i=null;return}s=i.parent().attr("data-id"),n._filterItemsById(s,function(e){n.trigger("itemTouch",{item:e.value})})}),n.$wrap.on("touchstart"+n.eventNs,function(e){if(!n._options.deleteSupport)return;r=e.touches[0],i=t(r.target),o=e.timeStamp,c=l=parseInt(r.pageX),p=h=parseInt(r.pageY),m=!1,a=!1;if(!i.hasClass("ui-historylist-itemwrap")&&!(i=i.parents(".ui-historylist-itemwrap")).length){i=null;return}i.addClass("ui-historylist-ontap"),i.css("width",i.width()-parseInt(i.css("border-left-width"))-parseInt(i.css("border-right-width")))}),n.$wrap.on("touchmove"+n.eventNs,function(e){if(!i)return;c=e.touches[0].pageX,p=e.touches[0].pageY,f===undefined&&(f=setTimeout(function(){Math.abs(p-h)>Math.abs(c-l)/2?a=!1:a=!0},10)),m=m||(c-l>=3||p-h>=3?!0:!1);if(!a){setTimeout(function(){i&&i.removeClass("ui-historylist-ontap")},150);return}v=(c-l)/n.$wrap.width(),i.addClass("ui-historylist-itemmoving"),i.removeClass("ui-historylist-ontap"),i.css("-webkit-transform","translate3d("+(c-l)+"px, 0, 0)"),i.css("opacity",1-v),e.preventDefault(),e.stopPropagation()}),n.$wrap.on("touchend"+n.eventNs+" touchcancel"+n.eventNs,function(e){if(!i)return;clearTimeout(f),f=undefined,s=i.parent().attr("data-id"),u=e.timeStamp,d=(c-l)/(u-o),g=Math.abs(c-l),i.removeClass("ui-historylist-ontap"),i.removeClass("ui-historylist-itemmoving"),g<n.$wrap.width()/3&&Math.abs(d)>.1&&a||g>=n.$wrap.width()/3&&a?n.removeItem(s,i):(i.css("width","auto"),i.css("-webkit-transform","translate3d(0, 0, 0)"),i.css("opacity",1),!m&&g<3&&n._filterItemsById(s,function(e){n.trigger("itemTouch",{item:e.value})})),i=null})},show:function(){var e=this;if(e.items.length===0)return;return e.sync===!1&&(e.$wrap.html(""),e.addItems(e.syncitems),e.sync=!0),e.$el.show(),e.isShow=!0,e},hide:function(){var e=this;return e.$el.hide(),e.isShow=!1,e},_getItemId:function(){var e=this;return e._itemId===undefined?e._itemId=1:++e._itemId,"__dd__"+e._itemId},_getFormatItem:function(e){var t=this;return Object.prototype.toString.call(e)==="[object String]"?{context:e,value:e,id:t._getItemId()}:{context:e.context||e.value,value:e.value||e.context,id:t._getItemId()}},addItem:function(e){var n=this,e=n._getFormatItem(e);return n.items.forEach(function(r,i){if(r.value===e.value){n.items.splice(i,1),t(n.$wrap.children()[i]).remove();return}}),n.$wrap.children().length===0?n.$wrap.append(n.tpl2html("item",e)):t(n.tpl2html("item",e)).insertBefore(n.$wrap.children()[0]),n.items.unshift(e),n},addItems:function(e){var t=this;return e.forEach(function(e){t.addItem(e)}),t},update:function(e){var t=this;return t.isShow?(t.$wrap.html(""),t.addItems(e),t.sync=!0):(t.syncitems=e,t.sync=!1),t},removeItem:function(e,t){var n=this,r,i,s;i=t.css("-webkit-transform"),s=/translate3d\((.*?),.*/.test(i)?RegExp.$1:0,r=parseInt(s,10)>=0?t.width():-t.width(),t.css("-webkit-transform","translate3d("+r+"px, 0, 0)"),t.on("transitionEnd"+n.eventNs+" webkitTransitionEnd"+n.eventNs,function(){t.parent().remove(),n._filterItemsById(e,function(e,t){n.items.splice(t,1),n.trigger("itemDelete",{item:e.value})})})},clear:function(){var e=this;return e.$wrap.html(""),e.items=[],e.sync=!0,e.hide(),e.trigger("clear"),e},disableDelete:function(){var e=this;return e._options.deleteSupport=!1,e.$clear.hide(),e},enableDelete:function(){var e=this;return e._options.deleteSupport=!0,e.$clear.show(),e},destroy:function(){var e=this;return e.$wrap.off(e.eventNs),e.$clear.off(e.eventNs),e.$wrap.remove(),e.$clear.remove(),e.$super("destroy")}})})(gmu,gmu.$);